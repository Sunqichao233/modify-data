# CSV数据处理需求文档

## 项目概述
对1006.csv文件进行复杂的时间计算和数据修改，实现基于Excel公式逻辑的链式时间计算。

## 详细需求列表

### 1. 基础列修改
- **Flag列修改**: 对除了course_id在2052-2083范围之外的所有行，在flag列添加日语字符"留"
- **New_course_id列**: 在flag列右边添加new_course_id列，只对没有"留"字的行复制同行的course_id值
- **Course_video_length列**: 对course_id在2052-2083范围的行，按顺序填入指定的时间数据：
  ```
  2052: 0:30:36, 2053: 0:30:02, 2054: 0:30:39, 2055: 0:30:03, 2056: 0:30:11,
  2057: 0:30:07, 2058: 0:30:56, 2059: 0:30:04, 2060: 0:30:35, 2061: 0:30:35,
  2062: 0:30:11, 2063: 0:30:05, 2064: 0:30:16, 2065: 0:30:47, 2066: 0:30:04,
  2067: 0:30:01, 2068: 0:30:01, 2069: 0:30:32, 2070: 0:30:39, 2071: 0:30:01,
  2072: 0:30:41, 2073: 0:30:48, 2074: 0:30:05, 2075: 0:30:04, 2076: 0:30:02,
  2077: 0:30:45, 2078: 0:30:54, 2079: 0:30:51, 2080: 0:30:04, 2081: 0:30:01,
  2082: 0:30:01, 2083: 0:30:36
  ```

### 2. 随机数据生成
- **Rest_time列**: 对course_id在2052-2083范围的行，填入3-5之间的随机整数
- **New_started_at_UTC列（2052行）**: 对每个course_id为2052的行，设置随机时间：
  - 日期：2025年8月1日、4日、5日中随机选择
  - 时间：上午9:01-10:01之间的随机时刻
  - 特殊设置：3个随机用户分别从8月7日、8月18日、8月19日开始

### 3. 复杂时间计算逻辑

#### 3.1 基础计算规则
- **Next_started_at**: 对所有2052-2083行，计算公式为 `new_started_at_UTC + course_video_length`
- **New_started_at**: 对所有2052-2083行，计算公式为 `new_started_at_UTC - 9小时`

#### 3.2 链式计算逻辑（2053-2083行）
- **时间间隔**: 使用rest_time（3-5分钟）而不是course_video_length作为间隔
- **计算基础**: 前一行的next_started_at + 当前行的rest_time
- **用户分组**: 按user_id分组，确保每个用户的时间序列独立且连续

#### 3.3 Excel公式逻辑实现
基于以下Excel公式的Python实现：
```excel
=LET(
  s, INDEX(S:S, ROW()-1),
  t, INDEX(T:T, ROW()-1),
  sp, s + TIME(0, t, 0),
  d, DATE(YEAR(s), MONTH(s), DAY(s)),
  IF(
    HOUR(sp) + MINUTE(sp)/60 >= 16.5,
    IF(
      RANDBETWEEN(0,1)=0,
      WORKDAY(s,1) + TIME(9,0,0) + TIME(0,RANDBETWEEN(0,30),0),
      WORKDAY(s,1) + TIME(13,0,0) + TIME(0,RANDBETWEEN(0,60),0)
    ),
    IF(
      HOUR(sp) < 9,
      d + TIME(9,0,0),
      IF(
        AND(
          TIME(HOUR(sp), MINUTE(sp), 0) >= TIME(10,30,0),
          TIME(HOUR(sp), MINUTE(sp), 0) < TIME(13,0,0)
        ),
        d + TIME(13,0,0) + TIME(0,RANDBETWEEN(0,60),0),
        sp
      )
    )
  )
)
```

### 4. 工作时间和假期规则
- **工作时间**: 
  - 上午：9:00-10:30
  - 下午：13:00-16:30
- **工作日**: 周一至周五
- **假期跳过**: 2025年8月11日-8月15日
- **超时处理**: 
  - 超过16:30：跳转到下一工作日的9:00-9:30或13:00-14:00（随机选择）
  - 早于9:00：调整到当天9:00
  - 10:30-13:00（午休）：跳转到13:00-14:00

### 5. 数据完整性要求
- **时间连续性**: 每个用户内部时间必须严格递增，不能倒退
- **用户独立性**: 不同用户的时间计算相互独立
- **格式一致性**: 时间格式统一为"YYYY/M/D H:MM"
- **编码兼容性**: 支持UTF-8编码，兼容Windows控制台输出

## 技术实现要点

### 1. 数据结构
- 按user_id分组处理数据
- 按course_id排序确保计算顺序
- 维护前一行的next_started_at用于链式计算

### 2. 时间处理
- 使用Python datetime模块
- 实现工作日判断和假期跳过
- 精确的时间格式转换和计算

### 3. 随机数生成
- 使用固定随机种子确保结果可重现
- 实现多种随机选择逻辑（时间、日期、数值）

### 4. 错误处理
- 文件存在性检查
- 列索引验证
- 时间解析异常处理
- 详细的处理日志输出

## 输出要求
- 生成处理后的CSV文件
- 保持原有数据结构和格式
- 提供详细的处理统计信息
- 支持增量处理和重复运行

## 验证标准
- 时间序列在每个用户内部严格递增
- 所有计算结果符合工作时间规则
- 假期日期被正确跳过
- Rest_time间隔被正确应用
- 多起始日期用户的时间计算正确
