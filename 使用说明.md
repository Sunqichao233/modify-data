# CSV数据处理脚本使用说明

## 文件说明

### 1. 核心文件
- **`final_csv_processor.py`** - 最终版本的处理脚本
- **`CSV数据处理需求文档.md`** - 完整的需求文档
- **`使用说明.md`** - 本使用说明文件

### 2. 输入输出
- **输入文件**: `1006.csv` (需要处理的原始CSV文件)
- **输出文件**: `1006_final_processed.csv` (处理后的结果文件)

## 快速开始

### 1. 环境准备
```bash
# 确保Python 3.6+已安装
python --version

# 将CSV文件重命名为1006.csv并放在脚本同目录下
```

### 2. 运行脚本
```bash
# 直接运行
python final_csv_processor.py

# 或者在Windows上
python3 final_csv_processor.py
```

### 3. 查看结果
- 处理完成后会生成 `1006_final_processed.csv`
- 控制台会显示详细的处理统计信息

## 配置选项

### 1. 基础配置
在脚本顶部的配置区域可以修改：

```python
# ========= 配置区域 =========
INPUT_FILE = "1006.csv"              # 输入文件名
OUTPUT_FILE = "1006_final_processed.csv"  # 输出文件名
RANDOM_SEED = 456                    # 随机种子（确保结果可重现）
```

### 2. 特殊用户起始日期
如需为特定用户设置特殊起始日期：

```python
SPECIAL_START_DATES = {
    '1004598': (2025, 8, 7, 9, 19),   # 用户ID: (年, 月, 日, 时, 分)
    '1004609': (2025, 8, 18, 9, 39),
    '1004612': (2025, 8, 19, 9, 24),
}
```

### 3. 视频时长数据
如需修改课程视频时长，编辑 `VIDEO_LENGTHS` 列表：

```python
VIDEO_LENGTHS = [
    "0:30:36", "0:30:02", "0:30:39", # 对应course_id 2052, 2053, 2054...
    # ... 共32个时长数据
]
```

## 功能详解

### 1. 基础列修改
- ✅ Flag列添加"留"字（排除2052-2083范围）
- ✅ New_course_id列复制（仅无"留"字的行）
- ✅ Course_video_length列填充指定时长
- ✅ Rest_time列生成3-5随机数

### 2. 时间计算
- ✅ 2052行生成随机UTC开始时间
- ✅ 链式计算2053-2083行的时间
- ✅ 应用复杂Excel公式逻辑
- ✅ 工作时间和假期规则处理

### 3. 数据完整性
- ✅ 按用户分组独立计算
- ✅ 时间严格递增验证
- ✅ UTF-8编码支持
- ✅ 详细错误处理和日志

## 输出示例

### 控制台输出
```
[14:30:15] 开始处理文件: 1006.csv
[14:30:15] 第一阶段：处理基础列修改...
[14:30:16] 第二阶段：处理时间计算...
[14:30:16] 处理用户ID: 1004595
[14:30:16] 处理用户ID: 1004597
[14:30:16] 处理完成！输出文件: 1006_final_processed.csv
[14:30:16] ==================================================
[14:30:16] 处理统计信息:
[14:30:16] 总行数: 1767
[14:30:16] Flag列更新: 1511
[14:30:16] New_course_id添加: 256
[14:30:16] Course_video_length添加: 256
[14:30:16] Rest_time添加: 256
[14:30:16] UTC时间设置: 8
[14:30:16] Next_started_at更新: 256
[14:30:16] New_started_at_UTC更新: 248
[14:30:16] New_started_at添加: 256
[14:30:16] ==================================================
[14:30:16] ✅ 所有处理完成！
```

### CSV输出格式
处理后的CSV文件将包含以下新增列：
- `new_course_id` - 复制的课程ID
- `course_video_length` - 课程视频时长
- `rest_time` - 休息时间（3-5分钟）
- `new_started_at_UTC` - UTC开始时间
- `next_started_at` - 下次开始时间
- `new_started_at` - 本地开始时间

## 故障排除

### 1. 常见错误

**文件不存在**
```
错误：输入文件 1006.csv 不存在
```
解决：确保CSV文件存在且文件名正确

**列不存在**
```
错误：找不到必需的列 - 'course_id'
```
解决：检查CSV文件是否包含必需的列（course_id, user_id, flag）

**编码问题**
```
UnicodeDecodeError
```
解决：确保CSV文件使用UTF-8编码保存

### 2. 性能优化
- 大文件处理：脚本已优化内存使用，支持大型CSV文件
- 处理时间：通常1000行数据处理时间<1秒

### 3. 结果验证
处理完成后可以检查：
- 时间序列是否在每个用户内部递增
- 工作时间规则是否正确应用
- 假期日期是否被跳过
- Rest_time间隔是否正确

## 技术支持

### 1. 日志分析
脚本提供详细的处理日志，包括：
- 处理阶段信息
- 用户处理进度
- 统计数据汇总
- 错误信息详情

### 2. 自定义扩展
脚本采用模块化设计，可以轻松扩展：
- 添加新的时间计算规则
- 修改工作时间设置
- 增加新的数据验证逻辑

### 3. 版本兼容性
- Python 3.6+
- Windows/Linux/macOS
- 标准库依赖，无需额外安装包

## 更新日志

### v1.0 (2025-10-06)
- ✅ 完整实现所有需求功能
- ✅ 支持链式时间计算
- ✅ 工作时间和假期处理
- ✅ 用户分组独立计算
- ✅ 详细日志和统计信息
- ✅ 跨平台兼容性